<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - Restaurante Demo</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="pdv.html" class="nav-link">üí∞ PDV</a>
            <a href="cliente.html" class="nav-link">üçΩÔ∏è Cliente</a>
            <a href="entregador.html" class="nav-link">üèçÔ∏è Entregador</a>
            <a href="produtos.html" class="nav-link">üçï Produto</a>
            <a href="relatorios.html" class="nav-link">üìà Relat√≥rios</a>
            <a href="configuracoes.html" class="nav-link active">‚öôÔ∏è Configura√ß√µes</a>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Configura√ß√µes</h2>
            </div>
            <p style="color: var(--text-light);">
                Cadastre entregadores, formas de pagamento e defina o n√∫mero de mesas do restaurante.
            </p>
        </div>

        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Cadastro de Entregadores</h3>
                </div>
                <form id="form-entregadores">
                    <div class="form-group">
                        <label for="entregador-nome">Nome</label>
                        <input type="text" id="entregador-nome" placeholder="Ex: Joao Silva" required>
                    </div>
                    <div class="form-group">
                        <label for="entregador-placa">Placa da moto</label>
                        <input type="text" id="entregador-placa" placeholder="Ex: ABC1D23" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        Cadastrar Entregador
                    </button>
                </form>

                <div class="mt-2">
                    <h4 style="margin-bottom: 0.5rem;">Entregadores cadastrados</h4>
                    <div id="lista-entregadores" style="display: grid; gap: 0.5rem;"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Cadastro de Mesas</h3>
                </div>
                <form id="form-mesas">
                    <div class="form-group">
                        <label for="numero-mesas">Numero de Mesas</label>
                        <input type="number" id="numero-mesas" min="0" placeholder="Ex: 10" required>
                    </div>
                    <button type="submit" class="btn btn-secondary">
                        Salvar Numero de Mesas
                    </button>
                </form>
                <div class="mt-2">
                    <strong>Total configurado:</strong>
                    <span id="total-mesas">-</span>
                </div>
            </div>
        </div>

        <!-- Formas de Pagamento -->
        <div class="card" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h3 class="card-title">Formas de Pagamento</h3>
            </div>
            <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem;">
                As formas cadastradas aparecem no PDV e na tela de pedido online do cliente.
            </p>
            <form id="form-formas-pagamento">
                <div class="form-group" style="display: flex; gap: 0.75rem; align-items: flex-end; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label for="forma-pagamento-nome">Nome</label>
                        <input type="text" id="forma-pagamento-nome" placeholder="Ex: Pix, Cart√£o, Dinheiro" required>
                    </div>
                    <input type="hidden" id="forma-pagamento-id" value="">
                    <button type="submit" class="btn btn-primary" id="btn-salvar-forma">Cadastrar</button>
                    <button type="button" class="btn btn-secondary" id="btn-cancelar-forma" style="display: none;">Cancelar</button>
                </div>
            </form>
            <div class="mt-2">
                <h4 style="margin-bottom: 0.5rem;">Formas cadastradas</h4>
                <div id="lista-formas-pagamento" style="display: grid; gap: 0.5rem;"></div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // Carregar dados do restaurante
        const restaurante = dataManager.getRestaurante();
        // Header removido - elementos n√£o existem mais
        // const logoImg = document.getElementById('logo-img');
        // if (logoImg) logoImg.src = restaurante.logo;
        // const restauranteNome = document.getElementById('restaurante-nome');
        // if (restauranteNome) restauranteNome.textContent = restaurante.nome;

        const STORAGE_ENTREGADORES = 'peddy_entregadores';
        const STORAGE_MESAS = 'peddy_numero_mesas';

        const formEntregadores = document.getElementById('form-entregadores');
        const inputNome = document.getElementById('entregador-nome');
        const inputPlaca = document.getElementById('entregador-placa');
        const listaEntregadores = document.getElementById('lista-entregadores');

        const formMesas = document.getElementById('form-mesas');
        const inputNumeroMesas = document.getElementById('numero-mesas');
        const totalMesas = document.getElementById('total-mesas');

        function carregarEntregadores() {
            try {
                const salvo = JSON.parse(localStorage.getItem(STORAGE_ENTREGADORES) || '[]');
                return Array.isArray(salvo) ? salvo : [];
            } catch {
                return [];
            }
        }

        function salvarEntregadores(entregadores) {
            localStorage.setItem(STORAGE_ENTREGADORES, JSON.stringify(entregadores));
        }

        function renderizarEntregadores() {
            let entregadores = carregarEntregadores();
            if (entregadores.length === 0) {
                listaEntregadores.innerHTML = '<span style="color: var(--text-light);">Nenhum entregador cadastrado.</span>';
                return;
            }
            // Garantir que todos tenham id (migra√ß√£o para entregadores antigos)
            let alterado = false;
            entregadores = entregadores.map((e, i) => {
                if (!e.id) {
                    alterado = true;
                    return { ...e, id: 'ENT' + Date.now() + '-' + i };
                }
                return e;
            });
            if (alterado) salvarEntregadores(entregadores);

            listaEntregadores.innerHTML = entregadores.map(entregador => `
                <div class="card" style="padding: 0.75rem;">
                    <strong>${entregador.nome}</strong><br>
                    <span style="color: var(--text-light);">Placa: ${entregador.placa}</span>
                </div>
            `).join('');
        }

        formEntregadores.addEventListener('submit', (event) => {
            event.preventDefault();
            const nome = inputNome.value.trim();
            const placa = inputPlaca.value.trim();

            if (!nome || !placa) {
                return;
            }

            const entregadores = carregarEntregadores();
            const id = 'ENT' + Date.now() + '-' + entregadores.length;
            entregadores.push({ id, nome, placa });
            salvarEntregadores(entregadores);
            renderizarEntregadores();

            inputNome.value = '';
            inputPlaca.value = '';
            inputNome.focus();
        });

        formMesas.addEventListener('submit', (event) => {
            event.preventDefault();
            const quantidade = Number(inputNumeroMesas.value);
            if (Number.isNaN(quantidade) || quantidade < 0) {
                return;
            }
            localStorage.setItem(STORAGE_MESAS, String(quantidade));
            totalMesas.textContent = String(quantidade);
        });

        function carregarMesas() {
            const salvo = localStorage.getItem(STORAGE_MESAS);
            if (salvo === null || salvo === '') {
                totalMesas.textContent = '-';
                return;
            }
            totalMesas.textContent = salvo;
        }

        function renderizarFormasPagamento() {
            const lista = document.getElementById('lista-formas-pagamento');
            const formas = dataManager.getFormasPagamentoTodas();
            if (formas.length === 0) {
                lista.innerHTML = '<span style="color: var(--text-light);">Nenhuma forma de pagamento cadastrada.</span>';
                return;
            }
            lista.innerHTML = formas.map(f => {
                const nomeEsc = (f.nome || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `
                <div class="card" style="padding: 0.75rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
                    <div>
                        <strong>${(f.nome || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</strong>
                        ${f.ativa === false ? ' <span style="color: var(--text-light); font-size: 0.875rem;">(inativa)</span>' : ''}
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-small btn-secondary" data-forma-id="${f.id}" data-forma-nome="${nomeEsc}">Editar</button>
                        <button type="button" class="btn btn-small btn-danger" data-forma-id="${f.id}" data-forma-nome="${(f.nome || '').replace(/"/g, '&quot;')}">Excluir</button>
                    </div>
                </div>
            `;
            }).join('');
            lista.querySelectorAll('button[data-forma-id]').forEach(btn => {
                const id = btn.getAttribute('data-forma-id');
                const nome = btn.getAttribute('data-forma-nome') || '';
                if (btn.classList.contains('btn-danger')) {
                    btn.onclick = () => excluirFormaPagamento(Number(id), nome);
                } else {
                    btn.onclick = () => editarFormaPagamento(id, nome);
                }
            });
        }

        function editarFormaPagamento(id, nome) {
            document.getElementById('forma-pagamento-id').value = id;
            document.getElementById('forma-pagamento-nome').value = (nome || '').replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
            document.getElementById('btn-salvar-forma').textContent = 'Salvar';
            document.getElementById('btn-cancelar-forma').style.display = 'inline-block';
            document.getElementById('forma-pagamento-nome').focus();
        }

        function excluirFormaPagamento(id, nome) {
            const nomeExibir = (nome || '').replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
            if (!confirm('Excluir a forma de pagamento "' + nomeExibir + '"?')) return;
            dataManager.removerFormaPagamento(Number(id));
            renderizarFormasPagamento();
            document.getElementById('form-formas-pagamento').reset();
            document.getElementById('forma-pagamento-id').value = '';
            document.getElementById('btn-salvar-forma').textContent = 'Cadastrar';
            document.getElementById('btn-cancelar-forma').style.display = 'none';
        }

        document.getElementById('form-formas-pagamento').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('forma-pagamento-id').value;
            const nome = document.getElementById('forma-pagamento-nome').value.trim();
            if (!nome) return;
            if (id) {
                dataManager.atualizarFormaPagamento(Number(id), { nome });
            } else {
                dataManager.adicionarFormaPagamento({ nome });
            }
            renderizarFormasPagamento();
            document.getElementById('form-formas-pagamento').reset();
            document.getElementById('forma-pagamento-id').value = '';
            document.getElementById('btn-salvar-forma').textContent = 'Cadastrar';
            document.getElementById('btn-cancelar-forma').style.display = 'none';
        });

        document.getElementById('btn-cancelar-forma').addEventListener('click', function() {
            document.getElementById('forma-pagamento-id').value = '';
            document.getElementById('forma-pagamento-nome').value = '';
            document.getElementById('btn-salvar-forma').textContent = 'Cadastrar';
            document.getElementById('btn-cancelar-forma').style.display = 'none';
        });

        renderizarEntregadores();
        carregarMesas();
        renderizarFormasPagamento();
    </script>
</body>
</html>
