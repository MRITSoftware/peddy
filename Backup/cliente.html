<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido Online - Restaurante Demo</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="pdv.html" class="nav-link">üí∞ PDV</a>
            <a href="cliente.html" class="nav-link active">üçΩÔ∏è Cliente</a>
            <a href="entregador.html" class="nav-link">üèçÔ∏è Entregador</a>
            <a href="produtos.html" class="nav-link">üçï Produto</a>
            <a href="relatorios.html" class="nav-link">üìà Relat√≥rios</a>
            <a href="configuracoes.html" class="nav-link">‚öôÔ∏è Configura√ß√µes</a>
        </div>
    </nav>

    <div class="container" style="max-width: 900px; width: 90%; margin: 0 auto; padding: 1.5rem 1rem;">
        <div style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom: 1.5rem;">üíª Pedido Online</h2>
        </div>

        <form id="pedido-form">
            <!-- Dados do Cliente -->
            <div class="form-group">
                <label for="nome-cliente">Nome *</label>
                <input type="text" id="nome-cliente" required placeholder="Nome completo do cliente">
            </div>

            <div class="form-group">
                <label for="telefone-cliente">Telefone *</label>
                <input type="tel" id="telefone-cliente" required placeholder="(11) 98765-4321" 
                       pattern="[\(]\d{2}[\)]\s\d{4,5}[\-]\d{4}" 
                       oninput="formatarTelefone(this)">
            </div>

            <!-- Tipo de Pedido -->
            <div class="form-group">
                <label>Tipo de Pedido *</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="tipo-pedido" value="retirada" checked onchange="toggleEndereco()">
                        <span>Retirada</span>
                    </label>
                    <label>
                        <input type="radio" name="tipo-pedido" value="entrega" onchange="toggleEndereco()">
                        <span>Entrega</span>
                    </label>
                </div>
            </div>

            <!-- Endere√ßo (apenas para entrega) -->
            <div class="form-group" id="endereco-group" style="display: none;">
                <label for="endereco">Endere√ßo de Entrega *</label>
                <input type="text" id="endereco" placeholder="Rua, n√∫mero, bairro">
            </div>

            <!-- Pratos do Dia (destaque conforme o dia da semana) -->
            <div id="pratos-do-dia-section" class="form-group" style="display: none;">
                <div style="background: linear-gradient(135deg, var(--primary-color) 0%, #a83232 100%); color: white; padding: 1rem 1.25rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: var(--shadow-lg);">
                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">ü•ò Pratos do Dia</h3>
                    <p id="pratos-do-dia-subtitulo" style="margin: 0.25rem 0 0 0; font-size: 0.95rem; opacity: 0.95;">Pratos de segunda-feira</p>
                </div>
                <div id="pratos-do-dia-grid" class="grid grid-3"></div>
            </div>

            <!-- Sele√ß√£o de Produtos por Categoria -->
            <div class="form-group">
                <label>Selecione os Produtos</label>
                <div id="categorias-produtos"></div>
            </div>

            <!-- Itens Selecionados -->
            <div class="form-group">
                <label>Itens do Pedido</label>
                <div id="itens-selecionados" class="card" style="background: var(--light-color);">
                    <p style="text-align: center; color: var(--text-light);">Nenhum item selecionado</p>
                </div>
                <div id="total-pedido" style="text-align: right; margin-top: 1rem; font-size: 1.25rem; font-weight: 600; color: var(--primary-color);">
                    Total: R$ 0,00
                </div>
            </div>

            <!-- Observa√ß√µes -->
            <div class="form-group">
                <label for="observacoes">Observa√ß√µes</label>
                <textarea id="observacoes" placeholder="Ex: Sem cebola, bem passado, etc."></textarea>
            </div>

            <!-- Forma de Pagamento -->
            <div class="form-group">
                <label>Forma de Pagamento *</label>
                <div id="container-formas-pagamento-cliente" class="radio-group">
                    <!-- Preenchido por renderizarFormasPagamentoCliente() -->
                </div>
            </div>

            <!-- Bot√µes (mesma ordem do PDV: Realizar Pedido, Limpar) -->
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    Realizar Pedido
                </button>
                <button type="button" class="btn btn-secondary" onclick="limparPedido()">
                    Limpar
                </button>
            </div>
        </form>
    </div>

    <script src="data.js"></script>
    <script src="websocket-sim.js"></script>
    <script>
        // Itens selecionados (mesma l√≥gica do pedido online no PDV)
        let itensSelecionados = {};

        function sanitizarId(texto) {
            return texto.replace(/[^a-zA-Z0-9]/g, '-');
        }

        // Dia da semana atual do calend√°rio: pratos do dia s√£o exibidos SOMENTE no dia correspondente.
        // Segunda -> s√≥ segunda | Ter√ßa -> s√≥ ter√ßa | Quarta -> s√≥ quarta | Quinta -> s√≥ quinta
        // Sexta -> s√≥ sexta | S√°bado -> s√≥ s√°bado | Domingo -> s√≥ domingo
        // getDay(): 0=domingo, 1=segunda, 2=ter√ßa, 3=quarta, 4=quinta, 5=sexta, 6=s√°bado
        var DIAS_SEMANA = ['domingo', 'segunda', 'ter√ßa', 'quarta', 'quinta', 'sexta', 's√°bado'];
        var DIAS_SEMANA_TITULO = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];

        function getDiaAtual() {
            return DIAS_SEMANA[new Date().getDay()];
        }

        function getDiaAtualTitulo() {
            return DIAS_SEMANA_TITULO[new Date().getDay()];
        }

        // Placeholder quando o produto n√£o tem imagem (exibir sempre a √°rea da foto)
        var IMAGEM_PLACEHOLDER_PRATO = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI0NDQ0NDQyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjY2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5TZW0gSW1hZ2VtPC90ZXh0Pjwvc3ZnPg==';

        // Carregar e exibir Pratos do Dia SOMENTE no dia atual do calend√°rio (segunda s√≥ segunda, ter√ßa s√≥ ter√ßa, etc.)
        function carregarPratosDoDia() {
            var diaAtual = getDiaAtual(); // dia de hoje: domingo, segunda, ter√ßa, quarta, quinta, sexta ou s√°bado
            var diaTitulo = getDiaAtualTitulo();
            var cardapio = dataManager.getCardapio();
            // Exibir apenas produtos cujo pratoDoDia cont√©m o dia de HOJE (n√£o exibir pratos de outros dias)
            var pratosDoDia = cardapio.filter(function(p) {
                return p.pratoDoDia && Array.isArray(p.pratoDoDia) && p.pratoDoDia.indexOf(diaAtual) !== -1;
            });

            var section = document.getElementById('pratos-do-dia-section');
            var subtitulo = document.getElementById('pratos-do-dia-subtitulo');
            var grid = document.getElementById('pratos-do-dia-grid');

            if (pratosDoDia.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            subtitulo.textContent = 'Pratos de ' + diaTitulo.toLowerCase();
            grid.innerHTML = '';

            pratosDoDia.forEach(function(produto) {
                var imgSrc = (produto.imagem && produto.imagem.trim()) ? produto.imagem.trim() : IMAGEM_PLACEHOLDER_PRATO;
                var card = document.createElement('div');
                card.className = 'produto-card';
                card.style.border = '2px solid var(--primary-color)';
                card.style.boxShadow = '0 4px 12px rgba(214, 69, 69, 0.2)';
                card.onclick = function(e) { e.stopPropagation(); };
                card.innerHTML = '<img src="' + imgSrc + '" alt="' + (produto.nome || '') + '" class="produto-imagem" onerror="this.src=\'' + IMAGEM_PLACEHOLDER_PRATO + '\'; this.onerror=null;">' +
                    '<div class="produto-body">' +
                    '<span style="background: var(--primary-color); color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 6px; font-weight: 600;">ü•ò Prato do Dia</span>' +
                    '<div class="produto-nome">' + (produto.nome || '') + '</div>' +
                    '<div class="produto-categoria">' + (produto.categoria || '') + '</div>' +
                    '<div class="produto-preco">R$ ' + (produto.preco ? produto.preco.toFixed(2).replace('.', ',') : '0,00') + '</div>' +
                    (produto.descricao ? '<div class="produto-descricao">' + produto.descricao + '</div>' : '') +
                    '<div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 1rem;">' +
                    '<button type="button" class="btn btn-small btn-danger" onclick="event.stopPropagation(); removerItem(' + produto.id + ')">-</button>' +
                    '<span id="qtd-' + produto.id + '" style="font-weight: 600; min-width: 50px; text-align: center;">0</span>' +
                    '<button type="button" class="btn btn-small btn-secondary" onclick="event.stopPropagation(); adicionarItem(' + produto.id + ')">+</button>' +
                    '</div></div>';
                grid.appendChild(card);
            });
        }

        // Carregar card√°pio por categoria com acorde√£o (estrutura igual ao PDV online)
        function carregarCardapio() {
            const cardapio = dataManager.getCardapio();
            const categorias = [...new Set(cardapio.map(p => p.categoria))];
            const container = document.getElementById('categorias-produtos');
            container.innerHTML = '';

            categorias.forEach((categoria, index) => {
                const produtos = cardapio.filter(p => p.categoria === categoria);
                const categoriaId = sanitizarId(categoria);

                const categoriaDiv = document.createElement('div');
                categoriaDiv.className = 'categoria-acordeon';
                categoriaDiv.innerHTML = `
                    <div class="categoria-header" onclick="toggleCategoria('${categoriaId}')">
                        <h3 style="margin: 0; flex: 1;">${categoria}</h3>
                        <span class="categoria-arrow" id="arrow-${categoriaId}" style="transform: ${index === 0 ? 'rotate(0deg)' : 'rotate(-90deg)'};">${index === 0 ? '‚ñº' : '‚ñ∂'}</span>
                    </div>
                    <div class="categoria-content" id="content-${categoriaId}" style="display: ${index === 0 ? 'block' : 'none'};">
                        <div class="grid grid-3" id="produtos-${categoriaId}"></div>
                    </div>
                `;

                const produtosDiv = categoriaDiv.querySelector('#produtos-' + categoriaId);

                produtos.forEach(produto => {
                    const produtoCard = document.createElement('div');
                    produtoCard.className = 'produto-card';
                    produtoCard.onclick = (e) => e.stopPropagation();
                    produtoCard.innerHTML = `
                        <img src="${produto.imagem || ''}" alt="${produto.nome}" class="produto-imagem" onerror="this.style.display='none'">
                        <div class="produto-body">
                            <div class="produto-nome">${produto.nome}</div>
                            <div class="produto-categoria">${produto.categoria}</div>
                            <div class="produto-preco">R$ ${produto.preco.toFixed(2).replace('.', ',')}</div>
                            ${produto.descricao ? '<div class="produto-descricao">' + produto.descricao + '</div>' : ''}
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 1rem;">
                                <button type="button" class="btn btn-small btn-danger" onclick="event.stopPropagation(); removerItem(${produto.id})">-</button>
                                <span id="qtd-${produto.id}" style="font-weight: 600; min-width: 50px; text-align: center;">0</span>
                                <button type="button" class="btn btn-small btn-secondary" onclick="event.stopPropagation(); adicionarItem(${produto.id})">+</button>
                            </div>
                        </div>
                    `;
                    produtosDiv.appendChild(produtoCard);
                });

                container.appendChild(categoriaDiv);
            });
            carregarPratosDoDia();
        }

        function toggleCategoria(categoriaId) {
            const content = document.getElementById('content-' + categoriaId);
            const arrow = document.getElementById('arrow-' + categoriaId);

            if (content.style.display === 'none' || !content.style.display) {
                content.style.display = 'block';
                arrow.textContent = '‚ñº';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                arrow.textContent = '‚ñ∂';
                arrow.style.transform = 'rotate(-90deg)';
            }
        }

        function adicionarItem(produtoId) {
            const produto = dataManager.getProduto(produtoId);
            if (!produto) return;

            if (!itensSelecionados[produtoId]) {
                itensSelecionados[produtoId] = {
                    produtoId: produto.id,
                    nome: produto.nome,
                    quantidade: 0,
                    preco: produto.preco
                };
            }
            itensSelecionados[produtoId].quantidade++;
            atualizarInterface();
        }

        function removerItem(produtoId) {
            if (itensSelecionados[produtoId]) {
                itensSelecionados[produtoId].quantidade--;
                if (itensSelecionados[produtoId].quantidade <= 0) {
                    delete itensSelecionados[produtoId];
                }
                atualizarInterface();
            }
        }

        function atualizarInterface() {
            Object.keys(itensSelecionados).forEach(produtoId => {
                const qtdElement = document.getElementById('qtd-' + produtoId);
                if (qtdElement) {
                    qtdElement.textContent = itensSelecionados[produtoId].quantidade;
                }
            });

            const container = document.getElementById('itens-selecionados');
            const totalElement = document.getElementById('total-pedido');
            const itens = Object.values(itensSelecionados);

            if (itens.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">Nenhum item selecionado</p>';
                totalElement.textContent = 'Total: R$ 0,00';
            } else {
                container.innerHTML = itens.map(item => `
                    <div class="pedido-item">
                        <span>${item.nome} x${item.quantidade}</span>
                        <span style="font-weight: 600;">R$ ${(item.preco * item.quantidade).toFixed(2).replace('.', ',')}</span>
                    </div>
                `).join('');

                const total = itens.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
                totalElement.textContent = `Total: R$ ${total.toFixed(2).replace('.', ',')}`;
            }
        }

        function toggleEndereco() {
            const tipo = document.querySelector('input[name="tipo-pedido"]:checked').value;
            const enderecoGroup = document.getElementById('endereco-group');
            const enderecoInput = document.getElementById('endereco');

            if (tipo === 'entrega') {
                enderecoGroup.style.display = 'block';
                enderecoInput.required = true;
            } else {
                enderecoGroup.style.display = 'none';
                enderecoInput.required = false;
                enderecoInput.value = '';
            }
        }

        function formatarTelefone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length <= 10) {
                    value = value.replace(/^(\d{2})(\d{4})(\d{4}).*/, '($1) $2-$3');
                } else {
                    value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
                }
            }
            input.value = value;
        }

        function limparPedido() {
            if (confirm('Deseja limpar todos os itens do pedido?')) {
                itensSelecionados = {};
                document.getElementById('pedido-form').reset();
                toggleEndereco();
                atualizarInterface();

                const cardapio = dataManager.getCardapio();
                cardapio.forEach(produto => {
                    const qtdElement = document.getElementById('qtd-' + produto.id);
                    if (qtdElement) qtdElement.textContent = '0';
                });
            }
        }

        document.getElementById('pedido-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const itens = Object.values(itensSelecionados).filter(item => item.quantidade > 0);

            if (itens.length === 0) {
                return;
            }

            const tipo = document.querySelector('input[name="tipo-pedido"]:checked').value;
            const endereco = tipo === 'entrega' ? document.getElementById('endereco').value : null;

            if (tipo === 'entrega' && !endereco) {
                return;
            }

            const pedido = {
                cliente: document.getElementById('nome-cliente').value,
                telefone: document.getElementById('telefone-cliente').value,
                tipo: tipo,
                endereco: endereco,
                itens: itens,
                observacoes: document.getElementById('observacoes').value,
                pagamento: document.querySelector('input[name="pagamento"]:checked').value,
                tipoVenda: 'online'
            };

            const novoPedido = dataManager.adicionarPedido(pedido);

            // Salvar n√∫mero do pedido em cache e ir para acompanhamento
            try {
                localStorage.setItem('peddy_pedido_acompanhamento', novoPedido.id);
            } catch (e) {}
            window.location.href = 'acompanhamento.html?id=' + novoPedido.id;
        });

        function renderizarFormasPagamentoCliente() {
            const container = document.getElementById('container-formas-pagamento-cliente');
            if (!container) return;
            const formas = (typeof dataManager !== 'undefined' && dataManager.getFormasPagamento) ? dataManager.getFormasPagamento() : [];
            const lista = formas.length ? formas : [{ id: 0, nome: 'N√£o informado' }];
            const esc = (s) => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
            container.innerHTML = lista.map((f, i) => `
                <label>
                    <input type="radio" name="pagamento" value="${esc(f.nome)}" ${i === 0 ? 'checked' : ''}>
                    <span>${esc(f.nome)}</span>
                </label>
            `).join('');
        }

        // Ao carregar: se houver pedido em acompanhamento (cache) e ainda ativo, redirecionar para acompanhamento
        (function() {
            try {
                var id = localStorage.getItem('peddy_pedido_acompanhamento');
                if (!id) { carregarCardapio(); renderizarFormasPagamentoCliente(); return; }
                var raw = localStorage.getItem('restaurante_demo_data');
                if (!raw) { carregarCardapio(); renderizarFormasPagamentoCliente(); return; }
                var data = JSON.parse(raw);
                var pedidos = (data.pedidos || []).concat(data.pedidosFinalizados || []);
                var p = pedidos.find(function(x) { return x && x.id === id; });
                var finalizado = p && (p.status === 'finalizado' || p.status === 'entregue' || p.status === 'retirado');
                if (p && !finalizado) {
                    window.location.replace('acompanhamento.html?id=' + id);
                    return;
                }
                if (finalizado) localStorage.removeItem('peddy_pedido_acompanhamento');
            } catch (e) {}
            carregarCardapio();
            renderizarFormasPagamentoCliente();
        })();
    </script>
</body>
</html>
